<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Brew League Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .checkbox-item { transition: all 0.2s; }
    .checkbox-item:hover { transform: translateX(4px); }
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .progress-bar { transition: width 0.3s ease; }
    input[type="file"] { padding: 0.4rem; }
    @media print {
      body { background: white; }
      .no-print { display: none; }
    }
  </style>
</head>
<body class="p-4">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // SafeLS: localStorage wrapper with error handling
    const safeLS = {
      get(key) {
        try {
          const val = localStorage.getItem(key);
          return val;
        } catch (e) {
          console.warn('localStorage get error:', e);
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.warn('localStorage set error:', e);
        }
      },
      remove(key) {
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.warn('localStorage remove error:', e);
        }
      }
    };

    function App() {
      // Sections and items
      const sections = [
        {
          id: 'facility',
          title: 'Facility & Cleanliness',
          items: [
            { id: 'f1', label: 'Store exterior is clean and welcoming' },
            { id: 'f2', label: 'Floors are clean and free of debris' },
            { id: 'f3', label: 'Restrooms are clean and stocked' },
            { id: 'f4', label: 'Dining area is organized and sanitized' },
            { id: 'f5', label: 'Trash bins are not overflowing' }
          ]
        },
        {
          id: 'equipment',
          title: 'Equipment & Maintenance',
          items: [
            { id: 'e1', label: 'All equipment is in working order' },
            { id: 'e2', label: 'Espresso machine is clean and calibrated' },
            { id: 'e3', label: 'Grinders are clean and properly adjusted' },
            { id: 'e4', label: 'Refrigeration units are at correct temperature' },
            { id: 'e5', label: 'POS system is functioning correctly' }
          ]
        },
        {
          id: 'inventory',
          title: 'Inventory & Stock',
          items: [
            { id: 'i1', label: 'Coffee beans are fresh and properly stored' },
            { id: 'i2', label: 'Milk and dairy products are within expiration' },
            { id: 'i3', label: 'Syrups and flavorings are stocked and organized' },
            { id: 'i4', label: 'Cups, lids, and sleeves are adequately stocked' },
            { id: 'i5', label: 'Pastries and food items are fresh' }
          ]
        },
        {
          id: 'service',
          title: 'Customer Service',
          items: [
            { id: 's1', label: 'Staff greets customers warmly' },
            { id: 's2', label: 'Orders are taken accurately and promptly' },
            { id: 's3', label: 'Drinks are prepared consistently and correctly' },
            { id: 's4', label: 'Staff is knowledgeable about menu items' },
            { id: 's5', label: 'Customer complaints are handled professionally' }
          ]
        },
        {
          id: 'compliance',
          title: 'Safety & Compliance',
          items: [
            { id: 'c1', label: 'Health and safety guidelines are followed' },
            { id: 'c2', label: 'Food handling procedures are correct' },
            { id: 'c3', label: 'Fire extinguisher is accessible and inspected' },
            { id: 'c4', label: 'First aid kit is available and stocked' },
            { id: 'c5', label: 'Staff is wearing proper uniforms and name tags' }
          ]
        },
        {
          id: 'marketing',
          title: 'Marketing & Promotions',
          items: [
            { id: 'm1', label: 'Current promotions are clearly displayed' },
            { id: 'm2', label: 'Menu boards are up-to-date and legible' },
            { id: 'm3', label: 'Social media presence is active and engaging' },
            { id: 'm4', label: 'Loyalty program is promoted to customers' },
            { id: 'm5', label: 'Seasonal items are highlighted appropriately' }
          ]
        }
      ];

      // Flattened list of all items for easy lookup
      const allItems = sections.flatMap(sec => sec.items);

      // Load responses from localStorage (JSON parse)
      const loadResponses = () => {
        const stored = safeLS.get('checklistResponses');
        if (stored) {
          try {
            return JSON.parse(stored);
          } catch (e) {
            return {};
          }
        }
        return {};
      };

      const [resp, setResp] = useState(loadResponses);
      const [participantName, setParticipantName] = useState(safeLS.get('participantName') || '');
      const [participantEmpID, setParticipantEmpID] = useState(safeLS.get('participantEmpID') || '');
      const [storeName, setStoreName] = useState(safeLS.get('storeName') || '');
      const [storeID, setStoreID] = useState(safeLS.get('storeID') || '');
      const [region, setRegion] = useState(safeLS.get('region') || '');
      const [imgs, setImgs] = useState([]);
      const [remarks, setRemarks] = useState(safeLS.get('remarks') || '');
      const [incompleteFields, setIncompleteFields] = useState([]);

      // Persist responses and form fields to localStorage whenever they change
      useEffect(() => {
        safeLS.set('checklistResponses', JSON.stringify(resp));
        safeLS.set('participantName', participantName);
        safeLS.set('participantEmpID', participantEmpID);
        safeLS.set('storeName', storeName);
        safeLS.set('storeID', storeID);
        safeLS.set('region',region);
        safeLS.set('remarks', remarks);
      }, [resp,participantName,participantEmpID,storeName,storeID,region,imgs,remarks]);

      const handleCheck = (itemId, value) => {
        setResp(prev => ({ ...prev, [itemId]: value }));
      };

      const handleImageUpload = (e) => {
        const files = Array.from(e.target.files);
        const readers = files.map(file => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });
        });
        Promise.all(readers).then(results => {
          setImgs(prev => [...prev, ...results]);
        });
      };

      const removeImage = (index) => {
        setImgs(prev => prev.filter((_, i) => i !== index));
      };

      // Check completion: all items answered + all required fields filled
      const checkCompletion = () => {
        const missing = [];
        // Check all checklist items
        allItems.forEach(item => {
          if (!resp[item.id]) {
            missing.push({ type: 'item', id: item.id, label: item.label });
          }
        });
        // Check required fields
        if (!participantName.trim()) missing.push({ type: 'field', id: 'participantName', label: 'Participant Name' });
        if (!participantEmpID.trim()) missing.push({ type: 'field', id: 'participantEmpID', label: 'Employee ID' });
        if (!storeName.trim()) missing.push({ type: 'field', id: 'storeName', label: 'Store Name' });
        if (!storeID.trim()) missing.push({ type: 'field', id: 'storeID', label: 'Store ID' });
        if (!region.trim()) missing.push({ type: 'field', id: 'region', label: 'Region' });
        return missing;
      };

      const progress = () => {
        const answered = allItems.filter(item => resp[item.id]).length;
        return Math.round((answered / allItems.length) * 100);
      };

      const generatePDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Brew League Checklist Report', 10, 10);
        doc.setFontSize(12);
        doc.text(`Participant: ${participantName}`, 10, 20);
        doc.text(`Employee ID: ${participantEmpID}`, 10, 28);
        doc.text(`Store Name: ${storeName}`, 10, 36);
        doc.text(`Store ID: ${storeID}`, 10, 44);
        doc.text(`Region: ${region}`, 10, 52);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 10, 60);

        let y = 70;
        sections.forEach(sec => {
          if (y > 270) {
            doc.addPage();
            y = 10;
          }
          doc.setFontSize(14);
          doc.text(sec.title, 10, y);
          y += 8;
          doc.setFontSize(10);
          sec.items.forEach(item => {
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            const answer = resp[item.id] || 'N/A';
            doc.text(`- ${item.label}: ${answer}`, 15, y);
            y += 6;
          });
          y += 4;
        });

        if (remarks.trim()) {
          if (y > 270) {
            doc.addPage();
            y = 10;
          }
          doc.setFontSize(12);
          doc.text('Remarks:', 10, y);
          y += 6;
          doc.setFontSize(10);
          const lines = doc.splitTextToSize(remarks, 180);
          lines.forEach(line => {
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            doc.text(line, 10, y);
            y += 6;
          });
        }

        doc.save('BrewLeague_Checklist.pdf');
      };

      const handleSubmit = () => {
        const missing = checkCompletion();
        setIncompleteFields(missing);
        if (missing.length > 0) {
          alert(`Please complete the following:\n` + missing.map(m => `- ${m.label}`).join('\n'));
          // Scroll to first missing field or item
          const firstMissing = missing[0];
          const el = document.getElementById(firstMissing.id);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // Prepare data
        const data = new URLSearchParams();
        data.append('participantName', participantName);
        data.append('participantEmpID', participantEmpID);
        data.append('storeName', storeName);
        data.append('storeID', storeID);
        data.append('region', region);
        data.append('remarks', remarks);
        data.append('responses', JSON.stringify(resp));
        data.append('images', JSON.stringify(imgs));

        // Google Apps Script Web App URL (replace with your actual deployed URL)
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwTQoVDE5jGV2oCt7rdC7GW2B0zKsFvMGqzW69zeXsNde_r-huxVrwP8q3_aptlLrKHlA/exec';

        fetch(scriptURL, {
          method: 'POST',
          body: data
        })
          .then(res => res.json())
          .then(result => {
            if (result.status === 'success') {
              alert('Checklist submitted successfully!');
              // Clear localStorage
              safeLS.remove('checklistResponses');
              safeLS.remove('participantName');
              safeLS.remove('participantEmpID');
              safeLS.remove('storeName');
              safeLS.remove('storeID');
              safeLS.remove('region');
              safeLS.remove('remarks');
              // Reset state
              setResp({});
              setParticipantName('');
              setParticipantEmpID('');
              setStoreName('');
              setStoreID('');
              setRegion('');
              setImgs([]);
              setRemarks('');
              setIncompleteFields([]);
            } else {
              alert('Submission failed: ' + (result.message || 'Unknown error'));
            }
          })
          .catch(err => {
            console.error('Submit error:', err);
            alert('An error occurred during submission. Please try again.');
          });
      };

      const completionPercent = progress();

      return (
        <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden fade-in">
          {/* Header */}
          <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
            <h1 className="text-3xl font-bold mb-2">â˜• Brew League Checklist</h1>
            <p className="text-purple-100">Comprehensive Store Evaluation</p>
          </div>

          {/* Progress Bar */}
          <div className="p-6 bg-gray-50 border-b border-gray-200">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-semibold text-gray-700">Completion Progress</span>
              <span className="text-sm font-bold text-indigo-600">{completionPercent}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div
                className="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full"
                style={{ width: completionPercent + '%' }}
              ></div>
            </div>
          </div>

          {/* Participant & Store Details */}
          <div className="p-6 border-b border-gray-200 bg-white">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Checklist Details</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Participant Name *</label>
                <input
                  type="text"
                  value={participantName}
                  onChange={e => setParticipantName(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter your name"
                  id="participantName"
                  style={{
                    backgroundColor: !participantName.trim() && incompleteFields.some(f => f.id === 'participantName') ? '#fee' : 'white'
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Employee ID *</label>
                <input
                  type="text"
                  value={participantEmpID}
                  onChange={e => setParticipantEmpID(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter employee ID"
                  id="participantEmpID"
                  style={{
                    backgroundColor: !participantEmpID.trim() && incompleteFields.some(f => f.id === 'participantEmpID') ? '#fee' : 'white'
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Store Name *</label>
                <input
                  type="text"
                  value={storeName}
                  onChange={e => setStoreName(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter store name"
                  id="storeName"
                  style={{
                    backgroundColor: !storeName.trim() && incompleteFields.some(f => f.id === 'storeName') ? '#fee' : 'white'
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Store ID *</label>
                <input
                  type="text"
                  value={storeID}
                  onChange={e => setStoreID(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Enter store ID"
                  id="storeID"
                  style={{
                    backgroundColor: !storeID.trim() && incompleteFields.some(f => f.id === 'storeID') ? '#fee' : 'white'
                  }}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Region *</label>
                <select value={region} onChange={e=>setRegion(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="region" style={{backgroundColor: !region.trim() && incompleteFields.some(f => f.id === 'region') ? '#fee' : 'white'}}>
                  <option value="">Select Region</option>
                  <option value="North">North</option>
                  <option value="South">South</option>
                  <option value="West">West</option>
                </select>
              </div>
            </div>
          </div>

          {/* Checklist Sections */}
          <div className="p-6">
            {sections.map((sec, idx) => (
              <div key={sec.id} className="mb-6">
                <h3 className="text-lg font-bold text-gray-800 mb-3 flex items-center">
                  <span className="bg-indigo-100 text-indigo-700 rounded-full w-8 h-8 flex items-center justify-center mr-2 text-sm">{idx + 1}</span>
                  {sec.title}
                </h3>
                <div className="space-y-2">
                  {sec.items.map(item => {
                    const isIncomplete = incompleteFields.some(f => f.id === item.id);
                    return (
                      <div
                        key={item.id}
                        id={item.id}
                        className="checkbox-item flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100"
                        style={{ backgroundColor: isIncomplete ? '#fef2f2' : '' }}
                      >
                        <label className="text-sm text-gray-700 flex-1">{item.label}</label>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => handleCheck(item.id, 'Yes')}
                            className={`px-4 py-1 rounded-md font-semibold transition ${
                              resp[item.id] === 'Yes' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-green-100'
                            }`}
                          >
                            Yes
                          </button>
                          <button
                            onClick={() => handleCheck(item.id, 'No')}
                            className={`px-4 py-1 rounded-md font-semibold transition ${
                              resp[item.id] === 'No' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-red-100'
                            }`}
                          >
                            No
                          </button>
                          <button
                            onClick={() => handleCheck(item.id, 'N/A')}
                            className={`px-4 py-1 rounded-md font-semibold transition ${
                              resp[item.id] === 'N/A' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-yellow-100'
                            }`}
                          >
                            N/A
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>

          {/* Remarks */}
          <div className="p-6 border-t border-gray-200 bg-gray-50">
            <label className="block text-sm font-semibold text-gray-700 mb-2">Additional Remarks</label>
            <textarea
              value={remarks}
              onChange={e => setRemarks(e.target.value)}
              rows="4"
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Any additional comments or observations..."
            ></textarea>
          </div>

          {/* Image Upload */}
          <div className="p-6 border-t border-gray-200">
            <label className="block text-sm font-semibold text-gray-700 mb-2">Upload Images (Optional)</label>
            <input
              type="file"
              accept="image/*"
              multiple
              onChange={handleImageUpload}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            {imgs.length > 0 && (
              <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                {imgs.map((img, i) => (
                  <div key={i} className="relative group">
                    <img src={img} alt={`upload-${i}`} className="w-full h-24 object-cover rounded-lg shadow" />
                    <button
                      onClick={() => removeImage(i)}
                      className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"
                    >
                      Ã—
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Action Buttons */}
          <div className="p-6 bg-gray-50 border-t border-gray-200 flex flex-col md:flex-row md:justify-between space-y-3 md:space-y-0">
            <button
              onClick={generatePDF}
              className="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition"
            >
              ðŸ“„ Download PDF
            </button>
            <button
              onClick={handleSubmit}
              className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow transition"
            >
              âœ… Submit Checklist
            </button>
          </div>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>